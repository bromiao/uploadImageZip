<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>GET IP</title>
  </head>
  <body>
    <div id="localIP"></div>
    <div id="realIP"></div>
  </body>
</html>
<!-- <script src="http://pv.sohu.com/cityjson?ie=utf-8"></script> -->
<!-- <script src="https://api.ipify.org?format=json"></script> -->
<script type="text/javascript">
  // 下面这行和上面的script一起使用  获取真实IP地址

  // document.querySelector('#realIP').textContent =
  //   returnCitySN['cip'] + ',' + returnCitySN['cname'] + '真实IP地址'
  // 下面的一堆 单独使用 获取本地的IP地址
  function findIP(callback) {
    var myPeerConnection =
      window.RTCPeerConnection || window.mozRTCPeerConnection || window.webkitRTCPeerConnection //compatibility for firefox and chrome
    var pc = new myPeerConnection({ iceServers: [] }),
      noop = function () {},
      localIPs = {},
      ipRegex = /([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/g,
      key

    function ipIterate(ip) {
      console.log(2222, ip)
      if (!localIPs[ip]) callback(ip)
      localIPs[ip] = true
    }
    pc.createDataChannel('')

    pc.onicecandidate = function (ice) {
      if (
        !ice ||
        !ice.candidate ||
        !ice.candidate.candidate ||
        !ice.candidate.candidate.match(ipRegex)
      )
        return

      ice.candidate.candidate.match(ipRegex).forEach(ipIterate)
    }

    pc.createOffer().then(function (sdp) {
      console.log(1111, sdp.sdp.split('\n'))
      sdp.sdp.split('\n').forEach(function (line) {
        if (line.indexOf('candidate') < 0) return
        line.match(ipRegex)?.forEach(ipIterate)
      })
      pc.setLocalDescription(sdp, noop, noop)
    })
  }

  findIP(function (ip) {
    let dom = document.getElementById('localIP')
    dom.innerHTML = '你的本地IP地址: ' + ip

    fetch('https://api.ipify.org?format=json')
      .then(res => res.json())
      .then(data => {
        document.querySelector('#realIP').textContent = '你的公网IP地址: ' + data.ip
      })
  })
</script>
